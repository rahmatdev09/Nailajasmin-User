<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - MBG System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #f1f5f9;
      }
      .sidebar-active {
        border-right: 4px solid #2563eb;
        background: #eff6ff;
        color: #2563eb;
      }
      #map {
        height: 450px;
        width: 100%;
        border-radius: 1.5rem;
        z-index: 10;
        border: 4px solid white;
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }

      /* Animasi Loading Spinner */
      .spinner {
        animation: rotate 2s linear infinite;
        width: 20px;
        height: 20px;
      }
      .spinner .path {
        stroke: currentColor;
        stroke-linecap: round;
        animation: dash 1.5s ease-in-out infinite;
      }
      @keyframes rotate {
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes dash {
        0% {
          stroke-dasharray: 1, 150;
          stroke-dashoffset: 0;
        }
        50% {
          stroke-dasharray: 90, 150;
          stroke-dashoffset: -35;
        }
        100% {
          stroke-dasharray: 90, 150;
          stroke-dashoffset: -124;
        }
      }
    </style>
  </head>
  <body class="flex min-h-screen">
    <aside class="w-64 bg-white border-r hidden md:flex flex-col">
      <div class="p-6">
        <h1 class="text-xl font-extrabold text-blue-600">MBG ADMIN</h1>
        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">
          Management System
        </p>
      </div>
      <nav class="flex-1 px-4 space-y-2">
        <button
          onclick="showSection('dashboard')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all sidebar-active"
          id="btn-dashboard"
        >
          <i class="fas fa-chart-pie mr-3"></i> Dashboard
        </button>
        <button
          onclick="showSection('users')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-users"
        >
          <i class="fas fa-users mr-3"></i> Karyawan
        </button>
        <button
          onclick="showSection('settings')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-settings"
        >
          <i class="fas fa-building mr-3"></i> Pengaturan Divisi
        </button>
        <button
          onclick="showSection('logabsen')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-logabsen"
        >
          <i class="fas fa-clipboard-list mr-3"></i> Log Absen
        </button>
        <button
          onclick="showSection('koordinat')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-koordinat"
        >
          <i class="fas fa-map-marker-alt mr-3"></i> Koordinat Lokasi
        </button>
      </nav>
      <div class="p-4 border-t">
        <button
          onclick="handleLogout()"
          class="w-full p-3 text-red-600 font-bold flex items-center"
        >
          <i class="fas fa-sign-out-alt mr-3"></i> Logout
        </button>
      </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
      <header
        class="h-16 bg-white border-b flex items-center justify-between px-8"
      >
        <h2 id="section-title" class="font-bold text-gray-800">Dashboard</h2>
        <div class="flex items-center gap-3">
          <span class="text-sm font-semibold text-gray-600">Administrator</span>
          <div
            class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs"
          >
            AD
          </div>
        </div>
      </header>

      <section
        id="content-area"
        class="p-6 md:p-8 pb-24 md:pb-8 overflow-y-auto"
      >
        <div id="section-dashboard" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
              class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"
            >
              <p class="text-sm text-gray-400 font-bold uppercase">
                Total Karyawan
              </p>
              <h3
                id="stat-total-users"
                class="text-3xl font-black text-gray-800"
              >
                0
              </h3>
            </div>
            <div
              class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"
            >
              <p class="text-sm text-gray-400 font-bold uppercase">
                Hadir Hari Ini
              </p>
              <h3
                id="stat-present-today"
                class="text-3xl font-black text-green-600"
              >
                0
              </h3>
            </div>
            <div
              class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"
            >
              <p class="text-sm text-gray-400 font-bold uppercase">
                Status Sistem
              </p>
              <h3 class="text-3xl font-black text-blue-600">AKTIF</h3>
            </div>
          </div>
        </div>

        <div id="section-users" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">Daftar Karyawan</h3>
            <button
              onclick="openUserModal()"
              class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700"
            >
              + Tambah Karyawan
            </button>
          </div>
          <div
            class="bg-white p-6 rounded-3xl overflow-hidden border border-gray-100 shadow-sm"
          >
            <input
              type="text"
              id="searchUser"
              placeholder="Cari karyawan..."
              onkeyup="loadUsers()"
              class="w-72 p-2 border rounded-xl text-sm"
            />
            <table class="w-full text-left mt-3">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Nama / ID
                  </th>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Divisi
                  </th>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Jabatan
                  </th>
                  <th
                    class="p-4 text-xs font-bold text-gray-400 uppercase text-center"
                  >
                    Aksi
                  </th>
                </tr>
              </thead>
              <tbody id="userTableBody"></tbody>
            </table>

            <div id="paginationUsers" class="flex gap-2 mt-4"></div>
          </div>
        </div>

        <div id="section-koordinat" class="hidden space-y-4">
          <h3 class="text-xl font-bold">Titik Koordinat Kantor</h3>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div
              class="lg:col-span-1 bg-white p-6 rounded-3xl shadow-sm border border-gray-100 space-y-4"
            >
              <div>
                <label class="text-[10px] font-bold text-gray-400 ml-2"
                  >LATITUDE</label
                >
                <input
                  type="text"
                  id="input-lat"
                  class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
                  placeholder="-6.xxx"
                />
              </div>
              <div>
                <label class="text-[10px] font-bold text-gray-400 ml-2"
                  >LONGITUDE</label
                >
                <input
                  type="text"
                  id="input-lon"
                  class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
                  placeholder="106.xxx"
                />
              </div>
              <div>
                <label class="text-[10px] font-bold text-gray-400 ml-2"
                  >RADIUS ABSENSI (KM)</label
                >
                <input
                  type="number"
                  id="input-radius"
                  step="0.01"
                  class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
                  placeholder="0.1"
                />
              </div>
              <button
                id="btn-save-coord"
                onclick="saveGlobalCoords()"
                class="w-full p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
              >
                <i class="fas fa-save"></i> <span>Simpan Lokasi Pusat</span>
              </button>
              <p class="text-[10px] text-gray-400 leading-relaxed p-2 italic">
                * Karyawan hanya bisa absen jika berada di dalam radius
                lingkaran biru.
              </p>
            </div>
            <div
              class="lg:col-span-2 bg-white p-4 rounded-3xl shadow-sm border border-gray-100"
            >
              <div id="map"></div>
            </div>
          </div>
        </div>

        <div id="section-settings" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">Pengaturan Divisi</h3>
            <button
              onclick="openModal('addDivModal')"
              class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg"
            >
              + Tambah Divisi
            </button>
          </div>
          <div
            id="divisionGrid"
            class="grid grid-cols-1 md:grid-cols-2 gap-4"
          ></div>
        </div>

        <div id="section-logabsen" class="hidden space-y-4">
          <input
            type="text"
            id="searchDiv"
            placeholder="Cari divisi..."
            onkeyup="loadDivisions()"
            class="w-72 p-2 border rounded-xl text-sm"
          />
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">Log Absensi Bulanan</h3>
            <button
              onclick="downloadExcel()"
              class="bg-green-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg"
            >
              <i class="fas fa-file-excel mr-2"></i> Download Excel
            </button>
          </div>

          <div class="flex gap-3 items-end">
            <div>
              <label class="text-xs font-bold text-gray-500"
                >Tanggal Mulai</label
              >
              <input
                type="date"
                id="filterStart"
                class="p-2 border rounded-xl text-sm"
              />
            </div>
            <button
              onclick="loadLogAbsen()"
              class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold"
            >
              Filter 2 Minggu
            </button>
          </div>
          <div
            class="bg-white rounded-3xl p-6 border border-gray-100 shadow-sm overflow-auto"
          >
            <table class="w-full text-sm">
              <thead id="logHead"></thead>
              <tbody id="logBody"></tbody>
            </table>

            <div id="logLoading" class="hidden text-center py-6">
              <div
                class="flex items-center justify-center gap-3 text-blue-600 font-semibold"
              >
                <svg class="spinner" viewBox="0 0 50 50">
                  <circle
                    class="path"
                    cx="25"
                    cy="25"
                    r="20"
                    fill="none"
                    stroke-width="5"
                  ></circle>
                </svg>
                Memuat data absensi...
              </div>
            </div>

            <div id="paginationLog" class="flex gap-2 mt-4"></div>
          </div>
        </div>
      </section>
    </main>

    <div
      id="detailModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[110] p-4"
    >
      <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 id="detailName" class="text-xl font-black">Riwayat Absensi</h3>
            <p
              class="text-xs text-gray-400 font-bold uppercase tracking-widest"
            >
              Database: daily_subcollection
            </p>
          </div>
          <button
            onclick="closeModal('detailModal')"
            class="text-gray-400 hover:text-red-500"
          >
            <i class="fas fa-times-circle text-2xl"></i>
          </button>
        </div>
        <div
          id="attendanceList"
          class="space-y-2 max-h-[50vh] overflow-y-auto pr-2"
        ></div>
        <button
          onclick="closeModal('detailModal')"
          class="w-full mt-6 p-4 bg-gray-100 rounded-2xl font-bold"
        >
          Tutup
        </button>
      </div>
    </div>

    <div
      id="userModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4"
    >
      <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
        <h3 id="userModalTitle" class="text-xl font-black mb-6">
          Data Karyawan
        </h3>
        <input type="hidden" id="editDocId" />
        <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
          <input
            type="text"
            id="userName"
            placeholder="Nama Lengkap"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          />
          <input
            type="text"
            id="userIdField"
            placeholder="Username/ID"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          />
          <input
            type="text"
            id="userPhone"
            placeholder="Nomor HP"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          />
          <input
            type="password"
            id="userPass"
            placeholder="Password"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          />
          <select
            id="userDivisi"
            onchange="syncGaji()"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          ></select>
          <select
            id="userJabatan"
            onchange="syncGaji()"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          >
            <option value="ANGGOTA">ANGGOTA</option>
            <option value="KOORDINATOR">KOORDINATOR</option>
          </select>
          <input
            type="text"
            id="userGaji"
            readonly
            class="w-full p-3 bg-blue-50 border-blue-100 border rounded-2xl outline-none font-bold text-blue-600"
          />
          <div class="flex gap-2 pt-4">
            <button
              onclick="closeModal('userModal')"
              class="flex-1 p-4 bg-gray-100 rounded-2xl font-bold"
            >
              Batal
            </button>
            <button
              id="btn-save-user"
              onclick="saveUser()"
              class="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"
            >
              <span>Simpan</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="addDivModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4"
    >
      <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
        <h3 class="text-xl font-black mb-6">Kelola Divisi</h3>
        <div class="space-y-4">
          <input
            type="text"
            id="addDivName"
            placeholder="Nama Divisi"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
          />
          <div class="grid grid-cols-2 gap-2">
            <input
              type="number"
              id="addDivGajiAnggota"
              placeholder="Gaji Anggota"
              class="p-3 bg-gray-50 border rounded-2xl outline-none"
            />
            <input
              type="number"
              id="addDivGajiKoor"
              placeholder="Gaji Koordinator"
              class="p-3 bg-gray-50 border rounded-2xl outline-none"
            />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-[10px] font-bold text-gray-400 ml-2"
                >JAM MASUK</label
              >
              <input
                type="time"
                id="addDivJamMasuk"
                class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
              />
            </div>
            <div>
              <label class="text-[10px] font-bold text-gray-400 ml-2"
                >JAM KELUAR</label
              >
              <input
                type="time"
                id="addDivJamKeluar"
                class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
              />
            </div>
          </div>
          <div class="flex gap-2 pt-4">
            <button
              onclick="closeModal('addDivModal')"
              class="flex-1 p-4 bg-gray-100 rounded-2xl font-bold"
            >
              Batal
            </button>
            <button
              id="btn-save-div"
              onclick="saveDivision()"
              class="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"
            >
              <span>Simpan</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="attendanceModal"
      class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[300] p-6"
    >
      <div
        class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl relative flex flex-col max-h-[90vh]"
      >
        <!-- HEADER -->
        <div class="flex justify-between items-center px-6 py-4 border-b">
          <h3 class="text-xl font-bold text-gray-800">Detail Absensi</h3>
          <button
            onclick="closeModal('attendanceModal')"
            class="text-gray-400 hover:text-red-500 text-xl"
          >
            ✕
          </button>
        </div>

        <!-- BODY (SCROLLABLE) -->
        <div class="overflow-y-auto px-6 py-5 space-y-5">
          <!-- FOTO -->
          <div class="flex justify-center">
            <img
              id="attendancePhoto"
              class="w-40 h-40 object-cover rounded-2xl shadow-md border"
            />
          </div>

          <!-- DETAIL DATA -->
          <div
            id="attendanceDetailContent"
            class="grid grid-cols-2 gap-4 text-sm"
          ></div>

          <!-- MAP -->
          <div>
            <h4 class="font-semibold mb-2 text-gray-700">Lokasi Absensi</h4>
            <iframe
              id="attendanceMap"
              class="w-full h-56 rounded-2xl border shadow-sm"
              loading="lazy"
            ></iframe>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="p-5 border-t">
          <button
            onclick="closeModal('attendanceModal')"
            class="w-full py-3 bg-gray-100 hover:bg-gray-200 rounded-2xl font-semibold"
          >
            Tutup
          </button>
        </div>
      </div>
    </div>

    <div
      id="successModal"
      class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[200] p-4"
    >
      <div
        class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl text-center animate-bounce-short"
      >
        <div
          class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"
        >
          <i class="fas fa-check text-2xl"></i>
        </div>
        <h3 class="text-lg font-black text-gray-800">Berhasil!</h3>
        <p class="text-sm text-gray-500 mt-1">Data telah diperbarui.</p>
      </div>
    </div>

    <!-- MOBILE BOTTOM NAV -->
    <div
      class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-[500]"
    >
      <div class="flex justify-around py-2 text-xs">
        <button
          onclick="
            showSection('dashboard');
            setActiveMobile(this);
          "
          class="mobile-nav flex flex-col items-center text-blue-600"
        >
          <i class="fas fa-chart-pie text-lg"></i>
          <span>Dashboard</span>
        </button>

        <button
          onclick="
            showSection('users');
            setActiveMobile(this);
          "
          class="mobile-nav flex flex-col items-center text-gray-500"
        >
          <i class="fas fa-users text-lg"></i>
          <span>Karyawan</span>
        </button>

        <button
          onclick="
            showSection('logabsen');
            setActiveMobile(this);
          "
          class="mobile-nav flex flex-col items-center text-gray-500"
        >
          <i class="fas fa-clipboard-list text-lg"></i>
          <span>Log</span>
        </button>

        <button
          onclick="
            showSection('settings');
            setActiveMobile(this);
          "
          class="mobile-nav flex flex-col items-center text-gray-500"
        >
          <i class="fas fa-building text-lg"></i>
          <span>Divisi</span>
        </button>

        <button
          onclick="
            showSection('koordinat');
            setActiveMobile(this);
          "
          class="mobile-nav flex flex-col items-center text-gray-500"
        >
          <i class="fas fa-map-marker-alt text-lg"></i>
          <span>Lokasi</span>
        </button>
      </div>
    </div>

    <script type="module">
      import {
        collection,
        doc,
        getDoc,
        getDocs,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

      let logPage = 1;
      const logPerPage = 5;
      const firebaseConfig = {
        apiKey: "AIzaSyAYIlOOvpsZEAmx8pNt08YhLjisyCAxHhY",
        authDomain: "puskesmas-keman-d25a6.firebaseapp.com",
        projectId: "puskesmas-keman-d25a6",
        storageBucket: "puskesmas-keman-d25a6.firebasestorage.app",
        messagingSenderId: "340139650693",
        appId: "1:340139650693:web:2fb2474b0d923e14aa03ec",
      };
      const app = initializeApp(firebaseConfig);
      export const db = getFirestore(app);
      let map, marker, circle;

      let currentPage = 1;
      const perPage = 5;

      // --- UTILS ---
      function setBtnLoading(btnId, isLoading, originalText) {
        const btn = document.getElementById(btnId);
        if (isLoading) {
          btn.disabled = true;
          btn.innerHTML = `<svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg> Memproses...`;
        } else {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      function triggerSuccess() {
        const modal = document.getElementById("successModal");
        modal.classList.replace("hidden", "flex");
        setTimeout(() => {
          modal.classList.replace("flex", "hidden");
        }, 1500);
      }

      function setActiveMobile(el) {
        document.querySelectorAll(".mobile-nav").forEach((btn) => {
          btn.classList.remove("text-blue-600");
          btn.classList.add("text-gray-500");
        });

        el.classList.remove("text-gray-500");
        el.classList.add("text-blue-600");
      }

      window.setActiveMobile = setActiveMobile;

      // // Sync mobile active
      // document.querySelectorAll(".mobile-nav").forEach((btn) => {
      //   btn.classList.remove("text-blue-600");
      //   btn.classList.add("text-gray-500");
      // });

      // const activeMobile = document.querySelector(
      //   `.mobile-nav[onclick*="${section}"]`,
      // );
      // if (activeMobile) {
      //   activeMobile.classList.remove("text-gray-500");
      //   activeMobile.classList.add("text-blue-600");
      // }

      // --- MAPS LOGIC ---
      function initMap(lat = -6.2, lon = 106.81, radius = 0.1) {
        if (!map) {
          map = L.map("map").setView([lat, lon], 17);
          L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          ).addTo(map);
        } else {
          map.setView([lat, lon], 17);
        }
        if (marker) map.removeLayer(marker);
        if (circle) map.removeLayer(circle);

        marker = L.marker([lat, lon]).addTo(map);
        circle = L.circle([lat, lon], {
          color: "#2563eb",
          fillColor: "#3b82f6",
          fillOpacity: 0.2,
          radius: radius * 1000,
        }).addTo(map);
      }

      async function loadGlobalCoordData() {
        const doc = await db.collection("settings").doc("lokasi_pusat").get();
        if (doc.exists) {
          const d = doc.data();
          document.getElementById("input-lat").value = d.lat;
          document.getElementById("input-lon").value = d.lon;
          document.getElementById("input-radius").value = d.radius_km;
          initMap(d.lat, d.lon, d.radius_km);
        } else {
          initMap();
        }
      }

      async function downloadExcel() {
        const wb = XLSX.utils.book_new();
        const usersSnap = await db.collection("users").get();

        let data = [];

        for (const user of usersSnap.docs) {
          const row = { Nama: user.data().name };
          const attSnap = await db
            .collection("attendance")
            .doc(user.id)
            .collection("daily")
            .get();

          attSnap.forEach((d) => {
            const tgl = new Date(d.data().date).toLocaleDateString("id-ID");
            row[tgl] =
              `${d.data().clockIn || "-"} | ${d.data().clockOut || "-"}`;
          });

          data.push(row);
        }

        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "Absensi");
        XLSX.writeFile(wb, "Rekap_Absensi.xlsx");
      }

      async function saveGlobalCoords() {
        const lat = parseFloat(document.getElementById("input-lat").value);
        const lon = parseFloat(document.getElementById("input-lon").value);
        const rad = parseFloat(document.getElementById("input-radius").value);

        if (isNaN(lat) || isNaN(lon))
          return alert("Masukkan koordinat yang valid!");

        setBtnLoading(
          "btn-save-coord",
          true,
          '<i class="fas fa-save"></i> Simpan Lokasi Pusat',
        );

        try {
          await db
            .collection("settings")
            .doc("lokasi_pusat")
            .set({
              lat,
              lon,
              radius_km: rad || 0.1,
            });
          triggerSuccess();
          initMap(lat, lon, rad);
        } catch (e) {
          alert("Gagal simpan");
        }

        setBtnLoading(
          "btn-save-coord",
          false,
          '<i class="fas fa-save"></i> Simpan Lokasi Pusat',
        );
      }

      // --- ATTENDANCE DETAIL ---
      async function showUserDetail(userDocId, name) {
        document.getElementById("detailName").innerText = name;
        const list = document.getElementById("attendanceList");
        list.innerHTML = `<p class="text-center py-4">Memuat data...</p>`;
        openModal("detailModal");

        try {
          const snapshot = await db
            .collection("attendance")
            .doc(userDocId)
            .collection("daily")
            .orderBy("date", "desc")
            .get();

          list.innerHTML = "";
          if (snapshot.empty) {
            list.innerHTML = `<p class="text-center py-10 text-gray-400">Tidak ada riwayat absensi.</p>`;
            return;
          }

          snapshot.forEach((doc) => {
            const d = doc.data();
            const dateFmt = new Date(d.date).toLocaleDateString("id-ID", {
              weekday: "long",
              day: "numeric",
              month: "short",
            });
            list.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-2xl border border-gray-100">
                            <div>
                                <p class="text-[10px] font-black text-gray-400 uppercase">${dateFmt}</p>
                                <p class="text-xs font-bold text-green-600">HADIR</p>
                            </div>
                            <div class="flex gap-4 text-right">
                                <div><p class="text-[8px] text-gray-400 font-bold uppercase">IN</p><p class="text-xs font-bold text-gray-800">${d.clockIn || "--:--"}</p></div>
                                <div><p class="text-[8px] text-gray-400 font-bold uppercase">OUT</p><p class="text-xs font-bold text-gray-800">${d.clockOut || "--:--"}</p></div>
                            </div>
                        </div>`;
          });
        } catch (e) {
          list.innerHTML = `<p class="text-center text-red-500">Error: Gagal memuat data</p>`;
        }
      }

      // --- CORE UI FUNCTIONS ---
      function showSection(section) {
        document
          .querySelectorAll("#content-area > div")
          .forEach((el) => el.classList.add("hidden"));
        document
          .getElementById(`section-${section}`)
          .classList.remove("hidden");
        document.getElementById("section-title").innerText =
          section === "koordinat"
            ? "Lokasi Kantor"
            : section.charAt(0).toUpperCase() + section.slice(1);
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("sidebar-active"));
        document
          .getElementById(`btn-${section}`)
          .classList.add("sidebar-active");

        if (section === "users") loadUsers();
        if (section === "settings") loadDivisions();
        if (section === "koordinat") {
          loadGlobalCoordData();
          setTimeout(() => {
            if (map) map.invalidateSize();
          }, 300);
        }
        if (section === "dashboard") loadStats();
        if (section === "logabsen") loadLogAbsen();
      }

      function loadUsers() {
        onSnapshot(collection(db, "users"), (snapshot) => {
          const tbody = document.getElementById("userTableBody");
          const keyword =
            document.getElementById("searchUser")?.value?.toLowerCase() || "";

          let data = [];

          snapshot.forEach((docSnap) => {
            const u = docSnap.data();

            if (!u.name?.toLowerCase().includes(keyword)) return;

            data.push({
              docId: docSnap.id, // ✅ simpan docId asli
              ...u,
            });
          });

          const totalPage = Math.ceil(data.length / perPage);
          const start = (currentPage - 1) * perPage;
          const paginated = data.slice(start, start + perPage);

          tbody.innerHTML = "";

          paginated.forEach((u, index) => {
            tbody.innerHTML += `
      <tr class="border-b">
        <td class="p-4 font-bold">${u.name}</td>
        <td class="p-4">${u.divisi}</td>
        <td class="p-4">${u.jabatan}</td>
        <td class="p-4 text-center">
          <button onclick="openUserModal('${u.docId}')">
            <i class="fas fa-edit text-blue-500"></i>
          </button>
        </td>
      </tr>`;
          });

          renderPagination(totalPage);
        });
      }
      function renderPagination(totalPage) {
        const el = document.getElementById("paginationUsers");
        el.innerHTML = "";
        for (let i = 1; i <= totalPage; i++) {
          el.innerHTML += `
      <button onclick="goPage(${i})"
        class="px-3 py-1 rounded-lg ${i === currentPage ? "bg-blue-600 text-white" : "bg-gray-100"}">
        ${i}
      </button>`;
        }
      }

      function goPage(p) {
        currentPage = p;
        loadUsers();
      }
      async function loadStats() {
        const users = await getDocs(collection(db, "users"));

        document.getElementById("stat-total-users").innerText = users.size;
        document.getElementById("stat-present-today").innerText = "Online";
      }

      async function syncGaji() {
        const divId = document.getElementById("userDivisi").value;
        const jab = document.getElementById("userJabatan").value;

        if (!divId) return;

        try {
          const docRef = doc(db, "divisi", divId);
          const snap = await getDoc(docRef);

          if (snap.exists()) {
            const d = snap.data();

            const nominal = jab === "KOORDINATOR" ? d.gaji_koordinator : d.gaji;

            document.getElementById("userGaji").value = nominal
              ? "Rp " + nominal.toLocaleString("id-ID")
              : "Rp 0";
          }
        } catch (err) {
          console.error("Error sync gaji:", err);
        }
      }

      async function openUserModal(docId = null) {
        // ✅ Ambil daftar divisi (v9)
        const divisiSnapshot = await getDocs(collection(db, "divisi"));

        const sel = document.getElementById("userDivisi");
        sel.innerHTML = '<option value="">Pilih Divisi</option>';

        divisiSnapshot.forEach((d) => {
          sel.innerHTML += `<option value="${d.id}">${d.id}</option>`;
        });

        // ==============================
        // MODE EDIT
        // ==============================
        if (docId) {
          const docRef = doc(db, "users", docId);
          const userSnap = await getDoc(docRef);

          if (userSnap.exists()) {
            const u = userSnap.data();

            document.getElementById("editDocId").value = docId; // ✅ FIX
            document.getElementById("userName").value = u.name || "";
            document.getElementById("userIdField").value = u.id || "";
            document.getElementById("userPhone").value = u.phone || "";
            document.getElementById("userPass").value = u.password || "";
            document.getElementById("userDivisi").value = u.divisi || "";
            document.getElementById("userJabatan").value = u.jabatan || "";

            syncGaji();
          } else {
            console.log("Dokumen tidak ditemukan");
          }
        } else {
          // ==============================
          // MODE TAMBAH
          // ==============================
          document.getElementById("editDocId").value = "";

          ["userName", "userIdField", "userPhone", "userPass"].forEach((i) => {
            document.getElementById(i).value = "";
          });
        }

        openModal("userModal");
      }

      async function saveUser() {
        const docId = document.getElementById("editDocId").value;

        const data = {
          name: document.getElementById("userName").value,
          id: document.getElementById("userIdField").value,
          phone: document.getElementById("userPhone").value,
          password: document.getElementById("userPass").value,
          divisi: document.getElementById("userDivisi").value,
          jabatan: document.getElementById("userJabatan").value,
          grade: "A",
        };

        setBtnLoading("btn-save-user", true, "Simpan");

        try {
          if (docId) {
            // UPDATE
            await updateDoc(doc(db, "users", docId), data);
          } else {
            // ADD
            await addDoc(collection(db, "users"), data);
          }

          closeModal("userModal");
          triggerSuccess();
        } catch (e) {
          console.error(e);
          alert("Gagal menyimpan user");
        }

        setBtnLoading("btn-save-user", false, "Simpan");
      }

      async function loadDivisions() {
        const snapshot = await getDocs(collection(db, "divisi"));

        const grid = document.getElementById("divisionGrid");
        const keyword =
          document.getElementById("searchDiv")?.value?.toLowerCase() || "";

        grid.innerHTML = "";

        snapshot.forEach((docSnap) => {
          if (!docSnap.id.toLowerCase().includes(keyword)) return;

          const d = docSnap.data();

          grid.innerHTML += `
      <div class="bg-white p-6 rounded-3xl border shadow-sm space-y-3">
        <div class="flex justify-between items-start">
          <h4 class="font-bold text-blue-600 text-lg">${docSnap.id}</h4>
          <div class="flex gap-2">
            <button onclick="editDivision('${docSnap.id}')">
              <i class="fas fa-edit text-blue-500"></i>
            </button>
            <button onclick="deleteDivision('${docSnap.id}')">
              <i class="fas fa-trash text-red-400"></i>
            </button>
          </div>
        </div>

        <div class="text-sm text-gray-600 space-y-1">
          <p><span class="font-semibold">Gaji Anggota:</span> Rp ${d.gaji?.toLocaleString("id-ID")}</p>
          <p><span class="font-semibold">Gaji Koordinator:</span> Rp ${d.gaji_koordinator?.toLocaleString("id-ID")}</p>
        </div>

        <div class="flex justify-between text-xs text-gray-500 pt-2 border-t">
          <span><strong>Jam Masuk:</strong> ${d.jam_masuk}</span>
          <span><strong>Jam Keluar:</strong> ${d.jam_keluar}</span>
        </div>
      </div>`;
        });
      }

      async function editDivision(id) {
        const snap = await getDoc(doc(db, "divisi", id));

        if (!snap.exists()) {
          alert("Divisi tidak ditemukan");
          return;
        }

        const d = snap.data();

        document.getElementById("addDivName").value = id;
        document.getElementById("addDivGajiAnggota").value = d.gaji;
        document.getElementById("addDivGajiKoor").value = d.gaji_koordinator;
        document.getElementById("addDivJamMasuk").value = d.jam_masuk;
        document.getElementById("addDivJamKeluar").value = d.jam_keluar;

        openModal("addDivModal");
      }

      async function loadLogAbsen() {
        const startInput = document.getElementById("filterStart").value;
        if (!startInput) return alert("Pilih tanggal mulai terlebih dahulu!");

        document.getElementById("logLoading").classList.remove("hidden");
        document.getElementById("logBody").innerHTML = "";

        const startDate = new Date(startInput);
        const dates = [];

        // Generate 14 hari
        for (let i = 0; i < 14; i++) {
          const d = new Date(startDate);
          d.setDate(startDate.getDate() + i);
          dates.push(new Date(d));
        }

        // ===== Render Header =====
        const logHead = document.getElementById("logHead");
        logHead.innerHTML = `
    <tr class="bg-gray-50 text-xs uppercase text-gray-500">
      <th class="p-3 text-center">No</th>
      <th class="p-3 text-left">Nama</th>
      <th class="p-3 text-left">Divisi</th>
      ${dates
        .map(
          (d) => `
        <th class="p-3 text-center border-l border-r border-gray-200">
          ${d.toLocaleDateString("id-ID", { day: "numeric", month: "short" })}
        </th>`,
        )
        .join("")}
    </tr>
  `;

        // ===== Ambil Semua User =====
        const usersSnap = await getDocs(collection(db, "users"));
        let data = [];

        for (const userDoc of usersSnap.docs) {
          const userData = userDoc.data();

          // ===== Ambil Subcollection attendance/{userId}/daily =====
          const attSnap = await getDocs(
            collection(db, "attendance", userDoc.id, "daily"),
          );

          let attendanceMap = {};

          attSnap.forEach((attDoc) => {
            const d = attDoc.data();
            const attDate = new Date(d.date);

            dates.forEach((date) => {
              if (attDate.toDateString() === date.toDateString()) {
                attendanceMap[date.toDateString()] = {
                  in: d.clockIn || "--:--",
                  out: d.clockOut || "--:--",
                };
              }
            });
          });

          data.push({
            userId: userDoc.id,
            name: userData.name,
            divisi: userData.divisi,
            attendance: attendanceMap,
          });
        }

        // Sort by divisi
        data.sort((a, b) => a.divisi.localeCompare(b.divisi));

        // Render pagination
        renderLogPagination(data, dates);

        document.getElementById("logLoading").classList.add("hidden");
      }

      function renderLogPagination(data, dates) {
        const totalPage = Math.ceil(data.length / logPerPage);
        const start = (logPage - 1) * logPerPage;
        const paginated = data.slice(start, start + logPerPage);

        const logBody = document.getElementById("logBody");
        logBody.innerHTML = "";

        paginated.forEach((u, index) => {
          logBody.innerHTML += `
      <tr class="border-b text-sm">
        <td class="p-3 text-center font-bold">${start + index + 1}</td>
        <td class="p-3 font-semibold whitespace-nowrap">${u.name}</td>
        <td class="p-3 whitespace-nowrap">${u.divisi}</td>

        ${dates
          .map((d) => {
            const att = u.attendance[d.toDateString()];

            // ISO DATE FIX (timezone safe)
            const isoDate =
              d.getFullYear() +
              "-" +
              String(d.getMonth() + 1).padStart(2, "0") +
              "-" +
              String(d.getDate()).padStart(2, "0");

            if (!att) {
              return `
              <td class="p-2 text-center border-l border-r border-gray-200">
                <span class="text-gray-300 text-xs">-</span>
              </td>`;
            }

            return `
            <td class="p-2 border-l border-r border-gray-200 cursor-pointer hover:bg-blue-50"
                onclick="openAttendanceDetail('${u.userId}', '${isoDate}')">
              <div class="flex flex-col items-center text-xs leading-tight">
                <span class="text-green-600 font-semibold">
                  IN: ${att.in}
                </span>
                <span class="text-blue-600 font-semibold">
                  OUT: ${att.out}
                </span>
              </div>
            </td>`;
          })
          .join("")}
      </tr>
    `;
        });

        const pag = document.getElementById("paginationLog");
        pag.innerHTML = "";

        for (let i = 1; i <= totalPage; i++) {
          pag.innerHTML += `
      <button onclick="goLogPage(${i})"
        class="px-3 py-1 rounded-lg ${
          i === logPage ? "bg-blue-600 text-white" : "bg-gray-100"
        }">
        ${i}
      </button>`;
        }
      }

      async function saveDivision() {
        const name = document
          .getElementById("addDivName")
          .value.toUpperCase()
          .trim();
        const g1 = parseInt(document.getElementById("addDivGajiAnggota").value);
        const g2 = parseInt(document.getElementById("addDivGajiKoor").value);
        const jm = document.getElementById("addDivJamMasuk").value; // Ambil Jam Masuk
        const jk = document.getElementById("addDivJamKeluar").value; // Ambil Jam Keluar

        if (!name || isNaN(g1) || isNaN(g2) || !jm || !jk)
          return alert("Data tidak lengkap! Pastikan jam kerja sudah diisi.");

        setBtnLoading("btn-save-div", true, "Simpan");
        try {
          await db.collection("divisi").doc(name).set({
            gaji: g1,
            gaji_koordinator: g2,
            jam_masuk: jm, // Simpan ke Firebase
            jam_keluar: jk, // Simpan ke Firebase
          });
          closeModal("addDivModal");
          triggerSuccess();
          loadDivisions();
        } catch (e) {
          alert("Gagal menyimpan divisi");
        }
        setBtnLoading("btn-save-div", false, "Simpan");
      }
      async function deleteUser(id) {
        if (confirm("Hapus?")) await db.collection("users").doc(id).delete();
      }
      async function deleteDivision(id) {
        if (confirm("Hapus?")) await db.collection("divisi").doc(id).delete();
      }

      function openModal(id) {
        document.getElementById(id).classList.replace("hidden", "flex");
      }
      function closeModal(id) {
        document.getElementById(id).classList.replace("flex", "hidden");
      }
      function handleLogout() {
        window.location.reload();
      }

      window.onload = () => {
        loadStats();
        showSection("dashboard");
      };

      async function openAttendanceDetail(userId, date) {
        const modal = document.getElementById("attendanceModal");
        const content = document.getElementById("attendanceDetailContent");
        const photo = document.getElementById("attendancePhoto");
        const map = document.getElementById("attendanceMap");

        modal.classList.remove("hidden");
        modal.classList.add("flex");

        console.log("USER ID:", userId);
        console.log("DATE PARAM:", date);

        const docRef = doc(db, "attendance", userId, "daily", date);
        const snap = await getDoc(docRef);

        if (!snap.exists()) {
          content.innerHTML = "Data tidak ditemukan";
          return;
        }

        const data = snap.data();

        // ===== FOTO =====
        photo.src = data.photoIn || "";
        photo.onerror = () => (photo.src = "https://via.placeholder.com/150");

        // ===== TIMESTAMP SAFE =====
        let formattedTime = "-";
        if (data.timestamp && typeof data.timestamp.toDate === "function") {
          formattedTime = data.timestamp.toDate().toLocaleString("id-ID");
        }

        // ===== DETAIL =====
        content.innerHTML = `
    <div>
      <div class="text-gray-500">Tanggal</div>
      <div class="font-semibold">${data.date || "-"}</div>
    </div>

    <div>
      <div class="text-gray-500">Jam Masuk</div>
      <div class="font-semibold ${
        isLate(data.clockIn) ? "text-red-600" : ""
      }">${data.clockIn || "-"}</div>
    </div>

    <div>
      <div class="text-gray-500">Jam Keluar</div>
      <div class="font-semibold">${data.clockOut || "-"}</div>
    </div>

    <div>
      <div class="text-gray-500">Latitude</div>
      <div class="font-semibold">${data.lat || "-"}</div>
    </div>

    <div>
      <div class="text-gray-500">Longitude</div>
      <div class="font-semibold">${data.lon || "-"}</div>
    </div>

    <div>
      <div class="text-gray-500">Timestamp</div>
      <div class="font-semibold">${formattedTime}</div>
    </div>
  `;

        // ===== MAP =====
        if (data.lat && data.lon) {
          map.src = `https://www.google.com/maps?q=${data.lat},${data.lon}&z=16&output=embed`;
          map.classList.remove("hidden");
        } else {
          map.classList.add("hidden");
        }
      }
      // cek jika telat
      function isLate(clockIn) {
        if (!clockIn) return false;

        const [hour, minute] = clockIn.split(":").map(Number);
        const totalMinutes = hour * 60 + minute;

        const limit = 7 * 60 + 30; // 07:30
        return totalMinutes > limit;
      }

      function goLogPage(p) {
        logPage = p;
        loadLogAbsen();
      }

      window.showSection = showSection;
      window.goLogPage = goLogPage;
      window.loadLogAbsen = loadLogAbsen;

      window.openAttendanceDetail = openAttendanceDetail;
      window.loadUsers = loadUsers;
      window.openUserModal = openUserModal;
      window.closeModal = closeModal;
      window.saveUser = saveUser;
      window.editDivision = editDivision;
      window.deleteDivision = deleteDivision;
      window.goPage = goPage;
      window.openModal = openModal;
    </script>
  </body>
</html>

