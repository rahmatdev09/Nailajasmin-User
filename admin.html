<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - MBG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #f1f5f9;
      }
      .sidebar-active {
        border-right: 4px solid #2563eb;
        background: #eff6ff;
        color: #2563eb;
      }
    </style>
  </head>
  <body class="flex min-h-screen">
    <aside class="w-64 bg-white border-r hidden md:flex flex-col">
      <div class="p-6">
        <h1 class="text-xl font-extrabold text-blue-600">MBG ADMIN</h1>
        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">
          Management System
        </p>
      </div>
      <nav class="flex-1 px-4 space-y-2">
        <button
          onclick="showSection('dashboard')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all sidebar-active"
          id="btn-dashboard"
        >
          <i class="fas fa-chart-pie mr-3"></i> Dashboard
        </button>
        <button
          onclick="showSection('users')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-users"
        >
          <i class="fas fa-users mr-3"></i> Karyawan
        </button>
        <button
          onclick="showSection('attendance')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-attendance"
        >
          <i class="fas fa-clipboard-check mr-3"></i> Log Absensi
        </button>
        <button
          onclick="showSection('settings')"
          class="nav-item w-full flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-xl transition-all"
          id="btn-settings"
        >
          <i class="fas fa-building mr-3"></i> Pengaturan Divisi
        </button>
      </nav>
      <div class="p-4 border-t">
        <button
          onclick="handleLogout()"
          class="w-full p-3 text-red-600 font-bold flex items-center"
        >
          <i class="fas fa-sign-out-alt mr-3"></i> Logout
        </button>
      </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
      <header
        class="h-16 bg-white border-b flex items-center justify-between px-8"
      >
        <h2 id="section-title" class="font-bold text-gray-800">Dashboard</h2>
        <div class="flex items-center gap-3">
          <span class="text-sm font-semibold text-gray-600">Administrator</span>
          <div
            class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs"
          >
            AD
          </div>
        </div>
      </header>

      <section id="content-area" class="p-8 overflow-y-auto">
        <div id="section-dashboard" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
              class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"
            >
              <p class="text-sm text-gray-400 font-bold uppercase">
                Total Karyawan
              </p>
              <h3
                id="stat-total-users"
                class="text-3xl font-black text-gray-800"
              >
                0
              </h3>
            </div>
            <div
              class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"
            >
              <p class="text-sm text-gray-400 font-bold uppercase">
                Hadir Hari Ini
              </p>
              <h3
                id="stat-present-today"
                class="text-3xl font-black text-green-600"
              >
                0
              </h3>
            </div>
            <div
              class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100"
            >
              <p class="text-sm text-gray-400 font-bold uppercase">
                Belum Absen
              </p>
              <h3
                id="stat-absent-today"
                class="text-3xl font-black text-red-600"
              >
                0
              </h3>
            </div>
          </div>
        </div>

        <div id="section-users" class="hidden space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">Daftar Karyawan</h3>
            <button
              onclick="openModal('userModal')"
              class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700"
            >
              + Tambah Karyawan
            </button>
          </div>
          <div
            class="bg-white rounded-3xl overflow-hidden border border-gray-100 shadow-sm"
          >
            <table class="w-full text-left">
              <thead class="bg-gray-50 border-b border-gray-100">
                <tr>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Nama / ID
                  </th>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Divisi
                  </th>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Jabatan
                  </th>
                  <th class="p-4 text-xs font-bold text-gray-400 uppercase">
                    Aksi
                  </th>
                </tr>
              </thead>
              <tbody id="userTableBody"></tbody>
            </table>
          </div>
        </div>

        <div id="section-attendance" class="hidden space-y-4">
          <h3 class="text-xl font-bold">Log Absensi Hari Ini</h3>
          <div
            id="attendanceGrid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
          ></div>
        </div>

        <div id="section-settings" class="hidden space-y-4">
          <h3 class="text-xl font-bold">Pengaturan Lokasi Divisi</h3>
          <div id="divisionGrid" class="grid grid-cols-1 gap-4"></div>
        </div>
      </section>
    </main>

    <div
      id="userModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4"
    >
      <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8">
        <h3 class="text-xl font-black mb-6">Tambah Karyawan Baru</h3>
        <div class="space-y-4">
          <input
            type="text"
            id="newUserId"
            placeholder="ID Karyawan (untuk login)"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500"
          />
          <input
            type="text"
            id="newUserName"
            placeholder="Nama Lengkap"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500"
          />
          <input
            type="password"
            id="newUserPass"
            placeholder="Kata Sandi"
            class="w-full p-3 bg-gray-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500"
          />
          <div class="grid grid-cols-2 gap-2">
            <input
              type="text"
              id="newUserDivisi"
              placeholder="Divisi (GIZI/DRIVER)"
              class="p-3 bg-gray-50 border rounded-2xl outline-none"
            />
            <input
              type="text"
              id="newUserJabatan"
              placeholder="Jabatan"
              class="p-3 bg-gray-50 border rounded-2xl outline-none"
            />
          </div>
          <div class="flex gap-2 pt-4">
            <button
              onclick="closeModal('userModal')"
              class="flex-1 p-4 bg-gray-100 rounded-2xl font-bold text-gray-500"
            >
              Batal
            </button>
            <button
              onclick="saveUser()"
              class="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg"
            >
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="editDivModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4"
    >
      <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8">
        <h3 class="text-xl font-black mb-2">
          Edit Divisi: <span id="editDivLabel" class="text-blue-600"></span>
        </h3>
        <p class="text-xs text-gray-400 mb-6 font-bold">
          PENGATURAN LOKASI & WAKTU
        </p>
        <input type="hidden" id="editDivId" />
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase"
                >Latitude</label
              >
              <input
                type="text"
                id="editDivLat"
                class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
              />
            </div>
            <div>
              <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase"
                >Longitude</label
              >
              <input
                type="text"
                id="editDivLon"
                class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
              />
            </div>
          </div>
          <div>
            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase"
              >Radius (KM)</label
            >
            <input
              type="number"
              id="editDivRadius"
              step="0.01"
              class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
            />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase"
                >Jam Masuk</label
              >
              <input
                type="time"
                id="editDivIn"
                class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
              />
            </div>
            <div>
              <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase"
                >Jam Pulang</label
              >
              <input
                type="time"
                id="editDivOut"
                class="w-full p-3 bg-gray-50 border rounded-2xl outline-none"
              />
            </div>
          </div>
          <div class="flex gap-2 pt-4">
            <button
              onclick="closeModal('editDivModal')"
              class="flex-1 p-4 bg-gray-100 rounded-2xl font-bold text-gray-500"
            >
              Batal
            </button>
            <button
              onclick="updateDivision()"
              class="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg"
            >
              Update
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- FIREBASE CONFIG ---
      const firebaseConfig = {
        apiKey: "AIzaSyAYIlOOvpsZEAmx8pNt08YhLjisyCAxHhY",
        authDomain: "puskesmas-keman-d25a6.firebaseapp.com",
        projectId: "puskesmas-keman-d25a6",
        storageBucket: "puskesmas-keman-d25a6.firebasestorage.app",
        messagingSenderId: "340139650693",
        appId: "1:340139650693:web:2fb2474b0d923e14aa03ec",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // --- NAVIGATION LOGIC ---
      function showSection(section) {
        document
          .querySelectorAll("#content-area > div")
          .forEach((el) => el.classList.add("hidden"));
        document
          .getElementById(`section-${section}`)
          .classList.remove("hidden");
        document.getElementById("section-title").innerText =
          section.charAt(0).toUpperCase() + section.slice(1);

        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("sidebar-active"));
        document
          .getElementById(`btn-${section}`)
          .classList.add("sidebar-active");

        if (section === "users") loadUsers();
        if (section === "attendance") loadAttendance();
        if (section === "settings") loadDivisions();
        if (section === "dashboard") loadStats();
      }

      // --- DATA LOADERS ---
      async function loadStats() {
        const users = await db.collection("users").get();
        document.getElementById("stat-total-users").innerText = users.size;

        const today = new Date().toISOString().split("T")[0];
        const attend = await db
          .collectionGroup("daily")
          .where("date", "==", today)
          .get();
        document.getElementById("stat-present-today").innerText = attend.size;
        document.getElementById("stat-absent-today").innerText = Math.max(
          0,
          users.size - attend.size,
        );
      }

      function loadUsers() {
        db.collection("users").onSnapshot((snap) => {
          const tbody = document.getElementById("userTableBody");
          tbody.innerHTML = "";
          snap.forEach((doc) => {
            const u = doc.data();
            tbody.innerHTML += `
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                            <td class="p-4">
                                <p class="font-bold text-gray-800">${u.name}</p>
                                <p class="text-[10px] text-gray-400 font-mono">${u.id}</p>
                            </td>
                            <td class="p-4 text-sm">${u.divisi || "-"}</td>
                            <td class="p-4 text-sm">${u.jabatan || "-"}</td>
                            <td class="p-4">
                                <button onclick="deleteUser('${doc.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
          });
        });
      }

      function loadAttendance() {
        const today = new Date().toISOString().split("T")[0];
        const grid = document.getElementById("attendanceGrid");
        grid.innerHTML =
          '<p class="text-gray-400 text-sm p-4 text-center col-span-full font-bold">Memuat data absensi real-time...</p>';

        db.collection("users")
          .get()
          .then((users) => {
            grid.innerHTML = "";
            users.forEach(async (userDoc) => {
              const attDoc = await db
                .collection("attendance")
                .doc(userDoc.id)
                .collection("daily")
                .doc(today)
                .get();
              if (attDoc.exists) {
                const d = attDoc.data();
                const userData = userDoc.data();
                grid.innerHTML += `
                            <div class="bg-white p-4 rounded-3xl border border-gray-100 shadow-sm">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs">
                                        ${userData.name.substring(0, 2).toUpperCase()}
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm leading-none">${userData.name}</p>
                                        <p class="text-[10px] text-gray-400">${userData.divisi}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="bg-blue-50 p-2 rounded-xl text-center">
                                        <p class="text-[8px] font-bold text-blue-400 uppercase">Masuk</p>
                                        <p class="text-sm font-black text-blue-700">${d.clockIn || "--:--"}</p>
                                    </div>
                                    <div class="bg-orange-50 p-2 rounded-xl text-center">
                                        <p class="text-[8px] font-bold text-orange-400 uppercase">Pulang</p>
                                        <p class="text-sm font-black text-orange-700">${d.clockOut || "--:--"}</p>
                                    </div>
                                </div>
                                ${d.photoIn ? `<img src="${d.photoIn}" class="w-full h-32 object-cover rounded-2xl border">` : ""}
                            </div>
                        `;
              }
            });
          });
      }

      function loadDivisions() {
        db.collection("divisi").onSnapshot((snap) => {
          const grid = document.getElementById("divisionGrid");
          grid.innerHTML = "";
          snap.forEach((doc) => {
            const d = doc.data();
            grid.innerHTML += `
                        <div class="bg-white p-6 rounded-3xl border border-gray-100 flex flex-col md:flex-row justify-between gap-4">
                            <div>
                                <h4 class="font-black text-blue-600 mb-1">${doc.id}</h4>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-tighter">Lokasi Koordinat:</p>
                                <p class="text-xs text-gray-600 mb-2">Lat: ${d.lat} | Lon: ${d.lon}</p>
                                <div class="flex gap-4">
                                    <div>
                                        <p class="text-[8px] font-bold text-gray-400 uppercase">Radius</p>
                                        <p class="text-xs font-bold">${d.radius_km} KM</p>
                                    </div>
                                    <div>
                                        <p class="text-[8px] font-bold text-gray-400 uppercase">Jam Kerja</p>
                                        <p class="text-xs font-bold">${d.jam_masuk} - ${d.jam_pulang}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="editDivision('${doc.id}')" class="bg-blue-50 text-blue-600 p-3 px-6 rounded-2xl text-xs font-black hover:bg-blue-100 transition-colors">
                                    <i class="fas fa-edit mr-2"></i>Edit Pengaturan
                                </button>
                            </div>
                        </div>
                    `;
          });
        });
      }

      // --- ACTIONS ---
      async function saveUser() {
        const id = document.getElementById("newUserId").value;
        const name = document.getElementById("newUserName").value;
        const pass = document.getElementById("newUserPass").value;
        const div = document.getElementById("newUserDivisi").value;
        const jab = document.getElementById("newUserJabatan").value;

        if (!id || !name || !pass) return alert("Lengkapi data!");

        try {
          await db.collection("users").add({
            id,
            name,
            password: pass,
            divisi: div,
            jabatan: jab,
            presence_count: 0,
            nik: "NIK-" + Math.floor(Math.random() * 1000),
          });
          closeModal("userModal");
          alert("Karyawan ditambahkan!");
        } catch (e) {
          alert(e.message);
        }
      }

      async function deleteUser(docId) {
        if (confirm("Hapus karyawan ini?")) {
          await db.collection("users").doc(docId).delete();
        }
      }

      // --- EDIT DIVISION LOGIC ---
      async function editDivision(divId) {
        const doc = await db.collection("divisi").doc(divId).get();
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("editDivId").value = divId;
          document.getElementById("editDivLabel").innerText = divId;
          document.getElementById("editDivLat").value = data.lat || 0;
          document.getElementById("editDivLon").value = data.lon || 0;
          document.getElementById("editDivRadius").value =
            data.radius_km || 0.1;
          document.getElementById("editDivIn").value =
            data.jam_masuk || "08:00";
          document.getElementById("editDivOut").value =
            data.jam_pulang || "16:00";
          openModal("editDivModal");
        }
      }

      async function updateDivision() {
        const id = document.getElementById("editDivId").value;
        const lat = parseFloat(document.getElementById("editDivLat").value);
        const lon = parseFloat(document.getElementById("editDivLon").value);
        const radius = parseFloat(
          document.getElementById("editDivRadius").value,
        );
        const inTime = document.getElementById("editDivIn").value;
        const outTime = document.getElementById("editDivOut").value;

        try {
          await db.collection("divisi").doc(id).update({
            lat: lat,
            lon: lon,
            radius_km: radius,
            jam_masuk: inTime,
            jam_pulang: outTime,
          });
          closeModal("editDivModal");
          alert("Pengaturan divisi " + id + " berhasil diperbarui!");
        } catch (e) {
          alert("Gagal update: " + e.message);
        }
      }

      // --- UTILS ---
      function openModal(id) {
        const el = document.getElementById(id);
        el.classList.remove("hidden");
        el.classList.add("flex");
      }
      function closeModal(id) {
        const el = document.getElementById(id);
        el.classList.remove("flex");
        el.classList.add("hidden");
      }
      function handleLogout() {
        window.location.reload();
      }

      // Init
      window.onload = () => loadStats();
    </script>
  </body>
</html>
