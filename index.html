<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>MBG Staff Portal</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#16a34a" />

    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap");
      html,
      body {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      body::-webkit-scrollbar {
        display: none;
      }
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #f8fafc;
        overflow-x: hidden;
      }
      .page-hidden {
        display: none !important;
      }
      .page-visible {
        display: block !important;
        animation: fadeIn 0.4s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .loader {
        border-top-color: #3b82f6;
        animation: spinner 0.8s linear infinite;
      }
      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #videoFeed {
        transform: scaleX(-1);
      }
      #map {
        height: 160px;
        border-radius: 1.5rem;
        z-index: 1;
      }

      /* Modal Style */
      #permissionModal {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }
    </style>
  </head>
  <body class="max-w-md mx-auto bg-slate-50 min-h-screen relative">
    <div
      id="permissionModal"
      class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6"
    >
      <div class="bg-white rounded-[2.5rem] w-full p-8 text-center shadow-2xl">
        <div
          class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full mx-auto flex items-center justify-center text-3xl mb-6"
        >
          <i class="fas fa-shield-alt"></i>
        </div>
        <h2 class="text-xl font-extrabold text-gray-800 mb-2">Izin Akses</h2>
        <p class="text-gray-500 text-sm mb-8">
          Untuk melakukan absensi, aplikasi memerlukan izin akses
          <b>Kamera</b> dan <b>Lokasi (GPS)</b> Anda.
        </p>
        <button
          onclick="requestAllPermissions()"
          class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all"
        >
          Izinkan Sekarang
        </button>
      </div>
    </div>

    <div
      id="loginPage"
      class="page-visible min-h-screen flex flex-col justify-center p-8 bg-white z-50"
    >
      <div class="text-center mb-10">
        <div
          class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center text-white text-3xl mb-4 shadow-xl"
        >
          <i class="fas fa-utensils"></i>
        </div>
        <h1 class="text-2xl font-extrabold text-gray-800 tracking-tight">
          MBG Portal
        </h1>
        <p class="text-gray-500 text-sm">Makan Bergizi Gratis - Karyawan</p>
      </div>
      <div class="space-y-4">
        <div class="relative">
          <i class="fas fa-id-badge absolute left-4 top-4 text-gray-400"></i>
          <input
            type="text"
            id="userId"
            class="w-full p-4 pl-12 bg-gray-50 border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="ID Karyawan"
          />
        </div>
        <div class="relative">
          <i class="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
          <input
            type="password"
            id="userPass"
            class="w-full p-4 pl-12 bg-gray-50 border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Kata Sandi"
          />
        </div>

        <div class="flex items-center px-2">
          <input
            type="checkbox"
            id="rememberMe"
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
          />
          <label for="rememberMe" class="ml-2 text-sm font-medium text-gray-500"
            >Ingat Saya</label
          >
        </div>

        <button
          onclick="handleLogin()"
          id="loginBtn"
          class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all"
        >
          Masuk
        </button>
      </div>
    </div>

    <div id="dashboardPage" class="page-hidden pb-28">
      <nav
        class="p-6 bg-white flex justify-between items-center sticky top-0 z-40 shadow-sm"
      >
        <div>
          <p
            class="text-[10px] text-blue-600 font-bold uppercase tracking-widest"
          >
            Selamat Bekerja
          </p>
          <p id="displayUserName" class="font-bold text-gray-800 text-lg">
            Memuat...
          </p>
        </div>
        <div
          id="userInitial"
          class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold shadow-md"
        >
          ..
        </div>
      </nav>

      <main class="p-4 space-y-5">
        <div class="grid grid-cols-2 gap-4">
          <div
            class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col items-center relative h-44 justify-center text-center"
          >
            <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-2">
              Presensi (12 Hari)
            </h3>
            <div
              id="chartLoading"
              class="absolute inset-0 flex items-center justify-center bg-white rounded-[2.5rem] z-10"
            >
              <div
                class="loader rounded-full border-4 border-gray-100 h-8 w-8"
              ></div>
            </div>
            <div class="w-24 h-24 relative">
              <canvas id="presenceChart"></canvas>
              <div
                class="absolute inset-0 flex flex-col items-center justify-center pt-4"
              >
                <span id="percentText" class="text-xl font-black text-gray-800"
                  >0%</span
                >
              </div>
            </div>
          </div>

          <div
            id="behaviorCard"
            class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center"
          >
            <h3 class="text-[10px] font-bold text-gray-400 uppercase">
              Grade Perilaku
            </h3>
            <span id="behaviorGrade" class="text-5xl font-black my-2">C</span>
            <p id="warningText" class="text-[9px] font-bold leading-tight"></p>
          </div>
        </div>

        <div
          class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100"
        >
          <p
            class="text-[10px] font-bold text-gray-400 uppercase mb-4 tracking-widest text-center"
          >
            Informasi Pekerjaan
          </p>
          <div class="grid grid-cols-3 gap-2">
            <div class="text-center border-r border-gray-100">
              <p class="text-[8px] font-bold text-blue-600 uppercase mb-1">
                Divisi
              </p>
              <p
                id="divisiText"
                class="text-[11px] font-extrabold text-gray-800"
              >
                ---
              </p>
            </div>
            <div class="text-center border-r border-gray-100">
              <p class="text-[8px] font-bold text-blue-600 uppercase mb-1">
                Jabatan
              </p>
              <p
                id="jabatanText"
                class="text-[11px] font-extrabold text-gray-800"
              >
                ---
              </p>
            </div>
            <div class="text-center">
              <p class="text-[8px] font-bold text-blue-600 uppercase mb-1">
                Gaji/Hari
              </p>
              <p id="gajiText" class="text-[11px] font-extrabold text-gray-800">
                Rp --
              </p>
            </div>
          </div>
        </div>

        <div
          class="bg-slate-900 rounded-[2.5rem] p-6 text-white shadow-2xl relative overflow-hidden"
        >
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-calendar-alt text-blue-400"></i>
            <span
              id="shiftTitle"
              class="text-xs font-bold uppercase tracking-widest"
              >Jadwal Shift</span
            >
          </div>
          <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
            <div>
              <p class="text-[9px] text-white/50 uppercase leading-none mb-1">
                Shift Masuk
              </p>
              <p id="shiftMasukText" class="text-xl font-bold">--:--</p>
            </div>
            <div>
              <p class="text-[9px] text-white/50 uppercase leading-none mb-1">
                Shift Pulang
              </p>
              <p id="shiftPulangText" class="text-xl font-bold">--:--</p>
            </div>
          </div>
        </div>

        <div
          class="bg-blue-50 rounded-[2.5rem] p-6 border border-blue-100 shadow-inner"
        >
          <p class="text-[10px] font-bold text-blue-400 uppercase mb-4">
            Absensi Hari Ini
          </p>
          <div class="flex justify-between items-center">
            <div>
              <p class="text-[9px] text-gray-500 uppercase">Jam Datang</p>
              <p id="clockInText" class="text-2xl font-black text-gray-300">
                --:--
              </p>
            </div>
            <div class="h-10 w-[1px] bg-blue-200"></div>
            <div>
              <p class="text-[9px] text-gray-500 uppercase text-right">
                Jam Pulang
              </p>
              <p
                id="clockOutText"
                class="text-2xl font-black text-gray-300 text-right"
              >
                --:--
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div id="scanPage" class="page-hidden p-4 bg-slate-50 min-h-screen">
      <div class="flex items-center gap-4 mb-6">
        <button
          onclick="pindahKe('dashboardPage')"
          class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-gray-600"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-xl font-black text-gray-800">Verifikasi Wajah</h2>
      </div>

      <div
        class="bg-white p-4 rounded-[2.5rem] shadow-sm border border-gray-100 mb-4 overflow-hidden"
      >
        <div id="map" class="mb-4"></div>

        <div class="flex items-center gap-3 mb-3 px-2">
          <div
            class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-xs"
          >
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="overflow-hidden">
            <p
              class="text-[10px] text-gray-400 font-bold uppercase leading-none"
            >
              Koordinat Kantor
            </p>
            <p
              id="officeCoordsText"
              class="text-[10px] font-mono text-gray-600 italic truncate"
            >
              Memuat lokasi...
            </p>
          </div>
        </div>

        <div
          id="radiusStatus"
          class="p-3 rounded-2xl bg-gray-50 flex items-center justify-between border border-gray-100"
        >
          <span class="text-[10px] font-bold text-gray-500 uppercase"
            >Radius: <span id="radiusVal">0</span> km</span
          >
          <span
            id="radiusBadge"
            class="px-3 py-1 rounded-full text-[9px] font-black uppercase bg-gray-200 text-gray-400"
            >Mengecek...</span
          >
        </div>
      </div>

      <div
        class="bg-slate-900 rounded-[2.5rem] overflow-hidden shadow-2xl border-4 border-white relative aspect-[3/4]"
      >
        <video
          id="videoFeed"
          autoplay
          playsinline
          class="w-full h-full object-cover"
        ></video>
        <canvas id="captureCanvas" class="hidden"></canvas>
        <div
          class="absolute inset-0 border-[30px] border-black/30 pointer-events-none"
        ></div>
        <div
          class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-64 border-2 border-dashed border-white/40 rounded-[3rem] pointer-events-none"
        ></div>
        <button
          id="captureBtn"
          onclick="prosesAbsensi()"
          class="absolute bottom-6 left-1/2 -translate-x-1/2 w-16 h-16 bg-white rounded-full border-4 border-blue-600 shadow-xl flex items-center justify-center active:scale-90 transition-transform"
        >
          <div class="w-10 h-10 bg-blue-600 rounded-full"></div>
        </button>
      </div>
    </div>

    <div id="profilePage" class="page-hidden p-6 bg-white min-h-screen pb-28">
      <h2 class="text-2xl font-black mb-8">Profil</h2>
      <div
        class="bg-slate-50 p-8 rounded-[3rem] text-center shadow-inner border border-gray-100 mb-6"
      >
        <div class="relative w-24 h-24 mx-auto mb-4">
          <div
            id="profileInitials"
            class="w-full h-full bg-blue-600 rounded-[2rem] border-8 border-white shadow-xl flex items-center justify-center text-white text-3xl font-bold"
          >
            ..
          </div>
        </div>
        <h3 id="profileName" class="font-bold text-xl text-gray-800">
          Memuat...
        </h3>
        <p id="profileNIK" class="text-sm text-gray-500 mb-4">NIK: --</p>
        <span
          id="profileJabatanBadge"
          class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest"
          >--</span
        >
      </div>
      <div class="space-y-4 mb-6">
        <p
          class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-2"
        >
          Edit Informasi
        </p>
        <div
          class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm space-y-3"
        >
          <div class="flex flex-col">
            <label
              class="text-[10px] font-bold text-blue-600 uppercase ml-1 mb-1"
              >Nama Lengkap</label
            >
            <input
              type="text"
              id="editName"
              class="p-3 bg-gray-50 rounded-xl outline-none focus:ring-1 focus:ring-blue-500 text-sm font-semibold"
            />
          </div>
          <div class="flex flex-col">
            <label
              class="text-[10px] font-bold text-blue-600 uppercase ml-1 mb-1"
              >No. WhatsApp</label
            >
            <input
              type="tel"
              id="editPhone"
              class="p-3 bg-gray-50 rounded-xl outline-none focus:ring-1 focus:ring-blue-500 text-sm font-semibold"
            />
          </div>
          <button
            onclick="updateFirebaseProfile()"
            class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold text-sm shadow-md active:scale-95 transition-all mt-2"
          >
            Simpan Perubahan
          </button>
        </div>
      </div>
      <button
        onclick="handleLogout()"
        class="w-full p-5 bg-red-50 text-red-600 font-bold rounded-2xl border border-red-100 active:bg-red-100 transition-all"
      >
        <i class="fas fa-sign-out-alt mr-2"></i> Keluar
      </button>
    </div>

    <div
      id="bottomNav"
      class="page-hidden fixed bottom-0 left-0 right-0 max-w-md mx-auto h-24 bg-white/90 backdrop-blur-xl border-t border-gray-100 flex justify-around items-center px-8 z-50"
    >
      <button
        onclick="pindahKe('dashboardPage')"
        id="nav-home"
        class="text-blue-600 flex flex-col items-center"
      >
        <i class="fas fa-home text-xl"></i>
        <span class="text-[9px] font-bold mt-1 uppercase">Home</span>
      </button>
      <button
        onclick="pindahKe('scanPage')"
        class="relative -mt-12 transition-transform active:scale-95"
      >
        <div
          class="w-16 h-16 bg-blue-600 rounded-full border-[6px] border-slate-50 shadow-blue-200 shadow-2xl flex flex-col items-center justify-center text-white"
        >
          <i class="fas fa-camera text-lg"></i>
          <span class="text-[7px] font-black uppercase mt-0.5 tracking-tighter"
            >Absen</span
          >
        </div>
      </button>
      <button
        onclick="pindahKe('profilePage')"
        id="nav-user"
        class="text-gray-400 flex flex-col items-center"
      >
        <i class="fas fa-user-circle text-xl"></i>
        <span class="text-[9px] font-bold mt-1 uppercase">Profil</span>
      </button>
    </div>

    <script>
      // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyAYIlOOvpsZEAmx8pNt08YhLjisyCAxHhY",
        authDomain: "puskesmas-keman-d25a6.firebaseapp.com",
        projectId: "puskesmas-keman-d25a6",
        storageBucket: "puskesmas-keman-d25a6.firebasestorage.app",
        messagingSenderId: "340139650693",
        appId: "1:340139650693:web:2fb2474b0d923e14aa03ec",
        measurementId: "G-TTZ9P53327",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let currentUserUID = null;
      let userData = null;
      let userLocation = { lat: null, lon: null };
      let officeData = { lat: 0, lon: 0, radius: 0 };
      let map, userMarker, officeCircle;
      let watchId = null;

      window.onload = () => {
        // Cek Ingat Saya
        const savedUID = localStorage.getItem("mbg_user_uid");
        const userIdSaved = localStorage.getItem("mbg_remember_id");
        const userPassSaved = localStorage.getItem("mbg_remember_pass");

        if (userIdSaved && userPassSaved) {
          document.getElementById("userId").value = userIdSaved;
          document.getElementById("userPass").value = userPassSaved;
          document.getElementById("rememberMe").checked = true;
        }

        if (savedUID) {
          currentUserUID = savedUID;
          loadUserData(savedUID);
          pindahKe("dashboardPage");
        } else {
          pindahKe("loginPage");
        }
      };

      function pindahKe(pageId) {
        const pages = ["loginPage", "dashboardPage", "profilePage", "scanPage"];
        pages.forEach((p) => {
          document
            .getElementById(p)
            .classList.replace("page-visible", "page-hidden");
        });

        document
          .getElementById(pageId)
          .classList.replace("page-hidden", "page-visible");

        const nav = document.getElementById("bottomNav");
        if (pageId === "loginPage" || pageId === "scanPage") {
          nav.classList.add("page-hidden");
          nav.classList.remove("flex");
        } else {
          nav.classList.remove("page-hidden");
          nav.classList.add("flex");
        }

        if (pageId === "scanPage") {
          // CEK APAKAH SUDAH PERNAH DIIZINKAN
          const camOk = localStorage.getItem("camera_granted");
          const locOk = localStorage.getItem("location_granted");

          if (camOk && locOk) {
            // Jika sudah pernah diizinkan, langsung jalankan tanpa modal
            document.getElementById("permissionModal").classList.add("hidden");
            startCamera();
            initMapAndLocation();
          } else {
            // Jika belum, baru tampilkan modal
            document
              .getElementById("permissionModal")
              .classList.remove("hidden");
          }
        } else {
          stopCamera();
          stopLocation();
        }

        document.getElementById("nav-home").className =
          pageId === "dashboardPage"
            ? "text-blue-600 flex flex-col items-center"
            : "text-gray-400 flex flex-col items-center";
        document.getElementById("nav-user").className =
          pageId === "profilePage"
            ? "text-blue-600 flex flex-col items-center"
            : "text-gray-400 flex flex-col items-center";
      }

      async function requestAllPermissions() {
        // Sembunyikan modal segera setelah klik
        document.getElementById("permissionModal").classList.add("hidden");

        try {
          // 1. Minta izin kamera terlebih dahulu (paling sensitif di iOS)
          const streamData = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });
          stream = streamData;
          document.getElementById("videoFeed").srcObject = stream;
          // Simpan status bahwa kamera sudah diizinkan
          localStorage.setItem("camera_granted", "true");

          // 2. Jika kamera berhasil, minta izin lokasi
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                // Berhasil mendapatkan posisi pertama kali
                userLocation.lat = pos.coords.latitude;
                userLocation.lon = pos.coords.longitude;
                // Lanjutkan ke monitoring lokasi real-time
                localStorage.setItem("location_granted", "true");
                initMapAndLocation();
              },
              (err) => {
                // Jika user menolak lokasi
                alert("Izin Lokasi ditolak. Anda tidak bisa absen.");
                pindahKe("dashboardPage");
              },
              { enableHighAccuracy: true, timeout: 10000 },
            );
          } else {
            alert("Browser Anda tidak mendukung Geolocation.");
            pindahKe("dashboardPage");
          }
        } catch (e) {
          // Jika user menolak kamera
          console.error("Camera Error:", e);
          alert("Izin Kamera ditolak. Anda tidak bisa absen.");
          pindahKe("dashboardPage");
        }
      }

      async function handleLogin() {
        const userId = document.getElementById("userId").value.trim();
        const pass = document.getElementById("userPass").value.trim();
        const remember = document.getElementById("rememberMe").checked;
        const btn = document.getElementById("loginBtn");

        if (!userId || !pass) return alert("Isi ID dan Kata Sandi");
        btn.disabled = true;
        btn.innerText = "Memverifikasi...";

        try {
          const snapshot = await db
            .collection("users")
            .where("id", "==", userId)
            .where("password", "==", pass)
            .limit(1)
            .get();
          if (snapshot.empty) throw new Error("ID atau Kata Sandi salah.");

          currentUserUID = snapshot.docs[0].id;
          localStorage.setItem("mbg_user_uid", currentUserUID);

          if (remember) {
            localStorage.setItem("mbg_remember_id", userId);
            localStorage.setItem("mbg_remember_pass", pass);
          } else {
            localStorage.removeItem("mbg_remember_id");
            localStorage.removeItem("mbg_remember_pass");
          }

          loadUserData(currentUserUID);
          pindahKe("dashboardPage");
        } catch (err) {
          alert(err.message);
        } finally {
          btn.disabled = false;
          btn.innerText = "Masuk";
        }
      }

      function loadUserData(uid) {
        db.collection("users")
          .doc(uid)
          .onSnapshot((doc) => {
            if (doc.exists) {
              userData = doc.data();
              updateUI(userData);
              loadDivisionShift(userData.divisi);
              initDashboardChart(userData.presence_count || 0);
              checkTodayAttendance(uid);
            } else {
              handleLogout();
            }
          });
      }

      async function loadDivisionShift(divisiName) {
        if (!divisiName) return;
        try {
          const divDoc = await db
            .collection("settings")
            .doc("lokasi_pusat")
            .get();
          if (divDoc.exists) {
            const d = divDoc.data();

            document.getElementById("shiftTitle").innerText =
              "Jadwal Shift " + divisiName;
            officeData = {
              lat: d.lat || 0,
              lon: d.lon || 0,
              radius: d.radius_km || 0.05,
            };
          }
          // =============================
          // 2. Ambil GAJI dari collection divisi
          // =============================
          const divisiDoc = await db.collection("divisi").doc(divisiName).get();

          if (divisiDoc.exists && userData) {
            const dataDivisi = divisiDoc.data();
            const jabatan = (userData.jabatan || "").toLowerCase();

            document.getElementById("shiftMasukText").innerText =
              dataDivisi.jam_masuk || "08:00";
            document.getElementById("shiftPulangText").innerText =
              dataDivisi.jam_pulang || "16:00";

            let gaji = 0;

            if (jabatan === "koordinator") {
              gaji = dataDivisi.gaji_koordinator || 0;
            } else {
              // Default staff biasa
              gaji = dataDivisi.gaji || 0;
            }

            document.getElementById("gajiText").innerText =
              "Rp " + gaji.toLocaleString("id-ID");
          }
        } catch (e) {
          console.error(e);
        }
      }

      function initMapAndLocation() {
        document.getElementById("officeCoordsText").innerText =
          `Lat: ${officeData.lat}, Lon: ${officeData.lon}`;
        document.getElementById("radiusVal").innerText = officeData.radius;

        if (!map) {
          map = L.map("map", {
            zoomControl: false,
            attributionControl: false,
          }).setView([officeData.lat, officeData.lon], 17);
          L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          ).addTo(map);

          officeCircle = L.circle([officeData.lat, officeData.lon], {
            color: "#3b82f6",
            fillColor: "#3b82f6",
            fillOpacity: 0.15,
            radius: officeData.radius * 1000,
          }).addTo(map);

          userMarker = L.marker([officeData.lat, officeData.lon]).addTo(map);
        }

        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (pos) => {
              userLocation.lat = pos.coords.latitude;
              userLocation.lon = pos.coords.longitude;

              const dist = calculateDistance(
                userLocation.lat,
                userLocation.lon,
                officeData.lat,
                officeData.lon,
              );
              const isInside = dist <= officeData.radius;

              userMarker.setLatLng([userLocation.lat, userLocation.lon]);
              map.panTo([userLocation.lat, userLocation.lon]);

              const badge = document.getElementById("radiusBadge");
              const capBtn = document.getElementById("captureBtn");

              if (isInside) {
                badge.innerText = "Dalam Radius";
                badge.className =
                  "px-3 py-1 rounded-full text-[9px] font-black uppercase bg-green-100 text-green-600 border border-green-200";
                capBtn.disabled = false;
                capBtn.style.opacity = "1";
              } else {
                badge.innerText = "Luar Area";
                badge.className =
                  "px-3 py-1 rounded-full text-[9px] font-black uppercase bg-red-100 text-red-600 border border-red-200";
                capBtn.disabled = true;
                capBtn.style.opacity = "0.4";
                document
                  .getElementById("outsideModal")
                  .classList.remove("hidden");
              }
            },
            (err) => {
              console.error(err);
            },
            { enableHighAccuracy: true },
          );
        }
      }

      function stopLocation() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
      }

      let stream = null;
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });
          document.getElementById("videoFeed").srcObject = stream;
        } catch (err) {
          throw err;
        }
      }
      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
      }

      async function prosesAbsensi() {
        const video = document.getElementById("videoFeed");
        const canvas = document.getElementById("captureCanvas");
        const context = canvas.getContext("2d");
        const today = new Date().toISOString().split("T")[0];
        const time = new Date().toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64Photo = canvas.toDataURL("image/jpeg", 0.5);

        try {
          const attRef = db
            .collection("attendance")
            .doc(currentUserUID)
            .collection("daily")
            .doc(today);
          const doc = await attRef.get();

          if (!doc.exists || !doc.data().clockIn) {
            await attRef.set({
              date: today,
              clockIn: time,
              photoIn: base64Photo,
              lat: userLocation.lat,
              lon: userLocation.lon,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
            await db
              .collection("users")
              .doc(currentUserUID)
              .update({
                presence_count: firebase.firestore.FieldValue.increment(1),
              });
          } else {
            await attRef.update({
              clockOut: time,
              photoOut: base64Photo,
              last_lat: userLocation.lat,
              last_lon: userLocation.lon,
            });
          }
          document.getElementById("successModal").classList.remove("hidden");
          pindahKe("dashboardPage");
        } catch (e) {
          alert("Gagal: " + e.message);
        }
      }

      function updateUI(data) {
        setPerilaku(data.grade);
        document.getElementById("displayUserName").innerText =
          data.name || "Karyawan";
        document.getElementById("profileName").innerText =
          data.name || "Karyawan";
        document.getElementById("editName").value = data.name || "";
        document.getElementById("editPhone").value = data.phone || "";
        document.getElementById("profileNIK").innerText =
          "NIK: " + (data.nik || "---");
        document.getElementById("divisiText").innerText = data.divisi || "---";
        document.getElementById("jabatanText").innerText =
          data.jabatan || "---";
        document.getElementById("profileJabatanBadge").innerText =
          data.jabatan || "---";
        document.getElementById("gajiText").innerText =
          "Rp " + (data.gaji || "0");
        if (data.name) {
          const initials = data.name
            .split(" ")
            .map((n) => n[0])
            .join("")
            .toUpperCase()
            .substring(0, 2);
          document.getElementById("userInitial").innerText = initials;
          document.getElementById("profileInitials").innerText = initials;
        }
      }

      function checkTodayAttendance(uid) {
        const today = new Date().toISOString().split("T")[0];
        db.collection("attendance")
          .doc(uid)
          .collection("daily")
          .doc(today)
          .onSnapshot((doc) => {
            if (doc.exists) {
              const d = doc.data();
              if (d.clockIn) {
                document.getElementById("clockInText").innerText = d.clockIn;
                document
                  .getElementById("clockInText")
                  .classList.replace("text-gray-300", "text-blue-600");
              }
              if (d.clockOut) {
                document.getElementById("clockOutText").innerText = d.clockOut;
                document
                  .getElementById("clockOutText")
                  .classList.replace("text-gray-300", "text-blue-600");
              }
            }
          });
      }

      let presenceChart;
      function initDashboardChart(hariHadir) {
        const totalPeriode = 12;
        const persen = Math.min(
          Math.round((hariHadir / totalPeriode) * 100),
          100,
        );
        if (document.getElementById("chartLoading"))
          document.getElementById("chartLoading").classList.add("page-hidden");
        document.getElementById("percentText").innerText = persen + "%";
        const ctx = document.getElementById("presenceChart").getContext("2d");
        if (presenceChart) presenceChart.destroy();
        presenceChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            datasets: [
              {
                data: [persen, 100 - persen],
                backgroundColor: ["#3b82f6", "#f1f5f9"],
                borderWidth: 0,
                circumference: 180,
                rotation: 270,
              },
            ],
          },
          options: { cutout: "85%", plugins: { tooltip: { enabled: false } } },
        });
      }

      function setPerilaku(grade) {
        const g = document.getElementById("behaviorGrade");
        const w = document.getElementById("warningText");
        const c = document.getElementById("behaviorCard");
        g.innerText = grade;
        if (grade === "C") {
          g.className = "text-5xl font-black my-2 text-red-600";
          w.innerHTML = "⚠️ SUDAH SP2!<br>1 KESALAHAN LAGI BERHENTI";
          w.className = "text-[9px] font-bold text-red-500";
          c.className =
            "bg-red-50 p-5 rounded-[2.5rem] border border-red-200 flex flex-col justify-center items-center text-center";
        }
      }

      async function updateFirebaseProfile() {
        const newName = document.getElementById("editName").value;
        const newPhone = document.getElementById("editPhone").value;
        try {
          await db
            .collection("users")
            .doc(currentUserUID)
            .update({ name: newName, phone: newPhone });
          alert("Profil diperbarui!");
        } catch (e) {
          alert(e.message);
        }
      }

      function handleLogout() {
        localStorage.removeItem("mbg_user_uid");
        // Jangan hapus mbg_remember_id/pass agar fitur ingat saya tetap ada
        pindahKe("loginPage");
      }

      function tutupSuccessModal() {
        document.getElementById("successModal").classList.add("hidden");
      }

      function tutupOutsideModal() {
        document.getElementById("outsideModal").classList.add("hidden");
      }

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("Service Worker Registered"));
      }
    </script>
    <!-- MODAL SUKSES -->
    <div
      id="successModal"
      class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/70 backdrop-blur-sm"
    >
      <div class="bg-white rounded-[2.5rem] w-full p-8 text-center shadow-2xl">
        <div
          class="w-20 h-20 bg-green-100 text-green-600 rounded-full mx-auto flex items-center justify-center text-3xl mb-6"
        >
          <i class="fas fa-check"></i>
        </div>
        <h2 class="text-xl font-extrabold text-gray-800 mb-2">
          Absensi Berhasil
        </h2>
        <p class="text-gray-500 text-sm mb-8">
          Data kehadiran Anda berhasil disimpan.
        </p>
        <button
          onclick="tutupSuccessModal()"
          class="w-full bg-green-600 text-white p-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all"
        >
          Tutup
        </button>
      </div>
    </div>

    <!-- MODAL LUAR AREA -->
    <div
      id="outsideModal"
      class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/70 backdrop-blur-sm"
    >
      <div class="bg-white rounded-[2.5rem] w-full p-8 text-center shadow-2xl">
        <div
          class="w-20 h-20 bg-red-100 text-red-600 rounded-full mx-auto flex items-center justify-center text-3xl mb-6"
        >
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <h2 class="text-xl font-extrabold text-gray-800 mb-2">
          Di Luar Area Kantor
        </h2>
        <p class="text-gray-500 text-sm mb-8">
          Anda berada di luar radius yang ditentukan. Silakan mendekat ke lokasi
          kantor untuk melakukan absensi.
        </p>
        <button
          onclick="tutupOutsideModal()"
          class="w-full bg-red-600 text-white p-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all"
        >
          Mengerti
        </button>
      </div>
    </div>
  </body>
</html>
